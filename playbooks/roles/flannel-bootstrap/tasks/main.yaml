---

#
# Initial member only:  Configure TLS
#
- block:

    - name:  "Install flanneld.service dropin to configure TLS on initial member"
      template:
        src: 30-certs.conf.j2
        dest: "{{dropin_dir_pat % 'flanneld.service'}}/30-certs.conf"
      register:  certs_dropin

    - name:  "Remove junk flanneld.service dropins"
      file:
        path: "{{dropin_dir_pat % 'flanneld.service'}}/{{item}}.conf"
        state: absent
      with_items:
        - "20-clct-flannel"
        - "50-network-config"

    - name:  "Reload systemd and restart flanneld.service"
      systemd:
        name: flanneld
        daemon_reload: yes
        state: restarted
      when:  "certs_dropin.changed|default(True)"

  when:  hostname == master_host
  become: true
  tags:
    - flannel-config
