---

#
# Add flannel config to etcd
#
- block:

    - name: "Check flannel config in etcd"
      shell: >-
        {{etcdctl_command}} get /coreos.com/network/config || echo no
      register:  etcd_flannel_config
      # This feels a little sketchy, but it seems to work
      changed_when: etcd_flannel_config.stdout != flannel_network_config

    - debug:
        var: flannel_network_config

    - name: "Publish flannel config to etcd"
      command: |
        {{etcdctl_command}} set /coreos.com/network/config
        '{{flannel_network_config}}'
      when: etcd_flannel_config.changed

  become: true
  tags:
    - flannel-config
    - flannel-etcd-config

#
# Get flanneld.service, flannel-docker-opts.service, docker.service
# started/restarted
#
- block:

    - name:  "Ensure flanneld.service unit is started"
      systemd:
        name: "flanneld.service"
        state:  started

    - name:  "Ensure flannel-docker-opts.service unit is unmasked and started"
      systemd:
        name: "flannel-docker-opts.service"
        masked:  false
        enabled:  true
        state:  started

    - name:  "Restart docker.service"
      systemd:
        name: "docker.service"
        state:  restarted

  become: true
  tags:
    - flannel-config
    - flannel-docker-opts
