---
#################################
# Configure etcd on CoreOS
#

#
# Add etcdctl command alias
#
- block:

    - name:  "Check if ~core/.bashrc is a symlink"
      stat:
        path: "/home/core/.bashrc"
      register:  bashrc_stat

    - name:  "Delete ~core/.bashrc symlink"
      file:
        path: "/home/core/.bashrc"
        state: absent
      when:  bashrc_stat.stat.islnk

    - name:  "Copy /usr/share/skel/.bashrc to ~core/.bashrc"
      command: "cp /usr/share/skel/.bashrc /home/core/.bashrc"
      when:  bashrc_stat.stat.islnk

    - name:  Add etcdctl command as alias
      lineinfile:
        dest: "/home/core/.bashrc"
        state: present
        insertafter: EOF
        line: "alias etcdctl='sudo {{etcdctl_command}}'"

  tags:
    - etcdctl-alias

#
# Create SRV records for etcd service discovery
#
- block:

    - name:  Create SRV records for etcd servers and clients
      ipa_dnsrecord:
        name: "_etcd-{{item.role}}-ssl._tcp"
        zone: "{{domain_name}}"
        srvrecord: "{{item.srvrec}}"
        state: exact
        ipa_host: "{{freeipa_master_fqdn}}"
        ipa_user: "{{ipa_user}}"
        ipa_pass: "{{freeipa_admin_password}}"
      with_items:
        -
          role: "server"
          srvrec: "{{ groups.coreos |
                      formatmaplist('0 100 2380 {}.%s.' % domain_name) }}"
        -
          role: "client"
          srvrec: "{{ groups.coreos |
                   formatmaplist('0 100 2379 {}.%s.' % domain_name) }}"
      # Once per run to install latest list
      run_once: yes
  delegate_to: localhost
  tags:
    - etcd-dns-srv

#
# Start etcd-member service
#
- block:

    - name:  "Unmask etcd-member.service"
      systemd:
        name: etcd-member
        masked: false
        enabled: true
        daemon_reload: yes
      register:  etcd_initial_mask

    - name:  "Start etcd-member.service"
      systemd:
        name: etcd-member
        enabled: true
        masked: false
        daemon_reload: yes
        state: restarted
      when:  "cert_tracking.changed or etcd_initial_mask.changed"
      
  become: true
  tags:
    - etcd-start
