---
# Install temporary etcd2 bootstrap config on CoreOS master

- block:
  # Tasks to run when etcd2 is not configured

  - name:  Install etcd2 service dropin directory
    file:
      path: "{{ dropin_dir_pat % 'etcd2' }}"
      state: directory
      mode: 0755
    become: true

  - name:  Install temporary bootstrap etcd service dropin
    template:
      src: 40-etcd2-bootstrap.conf.j2
      dest: "{{ dropin_dir_pat % 'etcd2' }}/40-etcd2-bootstrap.conf"
    register:  bootstrap_etcd_dropin
    become: true

  - name:  Install fleet service dropin directory
    file:
      path: "{{ dropin_dir_pat % 'fleet' }}"
      state: directory
      mode: 0755
    become: true

  - name:  Install temporary bootstrap fleet service dropin
    template:
      src: 40-fleet-bootstrap.conf.j2
      dest: "{{ dropin_dir_pat % 'fleet' }}/40-fleet-bootstrap.conf"
    register:  bootstrap_fleet_dropin
    become: true

  - name:  Reload systemd and restart etcd2
    systemd:
      name: etcd2
      daemon_reload: yes
      state: restarted
    when:  bootstrap_etcd_dropin.changed or not fleet_configured
    become: true

  - name:  Reload systemd and restart fleet
    systemd:
      name: fleet
      daemon_reload: yes
      state: restarted
    when:  bootstrap_fleet_dropin.changed or not fleet_configured
    become: true

  when: not etcd2_configured or not fleet_configured
